language: ruby
rvm:
  - 2.4.2
services:
  - mysql
  - docker
bundler_args: "--without development --deployment"
cache: bundler
before_script:
  - cp config/database.travis.yml config/database.yml
  - bundle exec rake db:create
  - bundle exec rake db:migrate
script:
  - bundle exec rspec
after_success:
  - docker --version  # document the version travis is using
  - pip install --user awscli # install aws cli w/o sudo
  - export PATH=$PATH:$HOME/.local/bin # put aws in the path
  - eval $(aws ecr get-login) #needs AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY envvars
  - ruby ./deploy/deploy.rb
before_deploy:
  - git checkout -- .
deploy:
  provider: heroku
  api_key:
    secure: h82iYpTD9+6dh6NCdYQGZY3rbdA7q/HP5kzQhRXduA26hpBq3VNMlb0VzPdd85fg3PqyGt82EYds6td7wSi2g0ah0DbCEoE9JzJRzId41waYeHOLBKCr8chZLVsTKojgkCI1mF+BV5lfa6SoAsabpVKDaMkAsqxnpEq0P+ReCq790EAw8bmacPHyWV5IdYMFVV+3CutILuqh6Yb+CTqZf0zZ41K705Hr8P2wwOsuw6lEIrB1Ywi5PKisd4NQRgyhQUumzUGbUf1mkawjpXO42qVrKiNLybDJCfG3UYKZ+k98VK7xddXmkbYBebMslzTq5WXiwI7ow5+/zCmoz7+a6puU/XFOtUvFu5P0Um7muaHKSedR5ZF2SACC+RAXek50RdTYI17S51DvByqdmXSw3yq8DZDFnraUhBg4A9gwYJTSo/xP1ILpcgqAgLOOzZlyo7V5zOCMPvSf4HbR0plp7L9YhsWFySxX3BqK8Hi8gcrRYzaiCN0U0w9mYWTWCLrd8npsJvpaeqsmSBXfen2PoWg0GXuTyKaFo18GZDXOdyKZ3M3Mbni2Vu7ivhrBrNdseZA8TejwpLkUaHxO3AQGhrx/gcgZN9GNzPoJif8UpxD8OpyhTSN8YAHbsGCZwb1qr89o98gPLtt9ddYBO7sKP48ajpS+tcSQpo5zahA1nPs=
  app:
    master: capibara-production
    develop: capibara-staging
    release/1.0: capibara-staging

